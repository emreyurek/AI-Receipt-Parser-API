@page "/"
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http.Headers
@using System.Text.Json
@using ReceiptParser.UI.Dto

@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager

<PageTitle>Fiş Tarayıcı</PageTitle>

<div class="app-container">

    <div class="header-section animate__animated animate__fadeInDown">
        <div class="logo-area">🧾</div>
        <h1 class="app-title">Fiş.AI</h1>
        <p class="app-subtitle">Harcamalarını saniyeler içinde analiz et.</p>
    </div>

    <div class="content-card animate__animated animate__fadeInUp">

        @if (!isLoading && analysisResult == null)
        {
            <div class="upload-wrapper">
                <InputFile OnChange="@LoadFiles" class="file-input" accept="image/*" />

                <div class="upload-content">
                    <div class="icon-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-camera-fill" viewBox="0 0 16 16">
                            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0" />
                            <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0" />
                        </svg>
                    </div>
                    <h3>Fişini Tara</h3>
                    <p>Fotoğraf çek veya galeriden yükle</p>
                </div>
            </div>

            @if (selectedFile != null)
            {
                <div class="selected-file-info animate__animated animate__fadeIn">
                    <span>📸 @selectedFile.Name</span>
                    <button class="btn-modern" @onclick="UploadReceipt">Analizi Başlat</button>
                </div>
            }
        }

        else if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner-ring"></div>
                <h4 class="loading-title">Yapay Zeka Çalışıyor</h4>

                <div class="steps-container">
                    <div class="step @(currentStep >= 1 ? "active" : "")">
                        <span class="dot"></span> Görsel Yükleniyor
                    </div>
                    <div class="step @(currentStep >= 2 ? "active" : "")">
                        <span class="dot"></span> Gemini AI Okuyor
                    </div>
                    <div class="step @(currentStep >= 3 ? "active" : "")">
                        <span class="dot"></span> Ürünler Ayrıştırılıyor
                    </div>
                    <div class="step @(currentStep >= 4 ? "active" : "")">
                        <span class="dot"></span> Sonuç Hazır
                    </div>
                </div>
            </div>
        }

        else if (analysisResult != null)
        {
            <div class="receipt-paper animate__animated animate__zoomIn">
                <div class="receipt-header">
                    <h2>@analysisResult.StoreName</h2>
                    <p>@analysisResult.ReceiptDate.ToShortDateString()</p>
                    <div class="dashed-line"></div>
                </div>

                <div class="receipt-body">
                    @if (analysisResult.LineItems != null)
                    {
                        @foreach (var item in analysisResult.LineItems)
                        {
                            <div class="receipt-item">
                                <div class="item-name">
                                    @item.ItemName
                                    <span class="item-category">@item.Category</span>
                                </div>
                                <div class="item-price">@item.TotalLineAmount.ToString("N2")</div>
                            </div>
                        }
                    }
                </div>

                <div class="receipt-footer">
                    <div class="dashed-line"></div>
                    <div class="total-row">
                        <span>TOPLAM</span>
                        <span class="total-price">@analysisResult.TotalAmount?.ToString("N2") TL</span>
                    </div>
                </div>
            </div>

            <button class="btn-secondary-modern" @onclick="ResetState">Yeni Fiş Ekle</button>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-box">
                <p>⚠️ @errorMessage</p>
                <button class="btn-text" @onclick="ResetState">Tekrar Dene</button>
            </div>
        }
    </div>
</div>

<style>

    .app-container {
        max-width: 480px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: #333;
    }

    .header-section {
        text-align: center;
        margin-bottom: 30px;
    }

    .logo-area {
        font-size: 3rem;
        margin-bottom: 10px;
    }

    .app-title {
        font-size: 1.8rem;
        font-weight: 800;
        margin: 0;
        color: #2c3e50;
    }

    .app-subtitle {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-top: 5px;
    }

    .upload-wrapper {
        position: relative;
        border: 2px dashed #e0e0e0;
        border-radius: 24px;
        background: #f9f9f9;
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        overflow: hidden;
    }

        .upload-wrapper:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

    .file-input {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 10;
    }

    .upload-content {
        text-align: center;
        pointer-events: none;
    }

    .icon-circle {
        width: 64px;
        height: 64px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        color: #3498db;
    }

    .upload-content h3 {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .upload-content p {
        color: #95a5a6;
        font-size: 0.85rem;
    }

    .selected-file-info {
        margin-top: 20px;
        text-align: center;
    }

    .btn-modern {
        background: #2c3e50;
        color: white;
        border: none;
        padding: 14px 30px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
        transition: transform 0.2s;
    }

        .btn-modern:active {
            transform: scale(0.98);
        }

    .btn-secondary-modern {
        background: white;
        color: #2c3e50;
        border: 2px solid #2c3e50;
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 600;
        width: 100%;
        margin-top: 20px;
        cursor: pointer;
    }

    .loading-container {
        text-align: left;
        padding: 20px;
    }

    .loading-title {
        text-align: center;
        margin-bottom: 30px;
        font-weight: 700;
    }

    .steps-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .step {
        display: flex;
        align-items: center;
        color: #bdc3c7;
        font-size: 0.9rem;
        transition: color 0.3s;
    }

        .step.active {
            color: #2c3e50;
            font-weight: 600;
        }

    .dot {
        width: 10px;
        height: 10px;
        background: #ecf0f1;
        border-radius: 50%;
        margin-right: 15px;
        transition: background 0.3s;
    }

    .step.active .dot {
        background: #27ae60;
        box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.2);
    }

    .spinner-ring {
        width: 40px;
        height: 40px;
        margin: 0 auto 20px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .receipt-paper {
        background: #fffdf9;
        border: 1px solid #f0e6d6;
        padding: 30px;
        border-radius: 10px 10px 0 0;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        position: relative;
        /* Zikzak efekti */
        clip-path: polygon(0 0, 100% 0, 100% 100%, 95% 98%, 90% 100%, 85% 98%, 80% 100%, 75% 98%, 70% 100%, 65% 98%, 60% 100%, 55% 98%, 50% 100%, 45% 98%, 40% 100%, 35% 98%, 30% 100%, 25% 98%, 20% 100%, 15% 98%, 10% 100%, 5% 98%, 0 100%);
        margin-bottom: 20px;
        font-family: 'Courier New', Courier, monospace;
        color: #4a4a4a;
    }

    .receipt-header {
        text-align: center;
        margin-bottom: 20px;
    }

        .receipt-header h2 {
            font-size: 1.4rem;
            font-weight: 900;
            margin: 0;
            text-transform: uppercase;
            color: #2c3e50;
        }

        .receipt-header p {
            font-size: 0.85rem;
            color: #95a5a6;
            margin-top: 5px;
        }

    .dashed-line {
        border-bottom: 2px dashed #dce1e3;
        margin: 15px 0;
    }

    .receipt-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 0.9rem;
    }

    .item-name {
        display: flex;
        flex-direction: column;
    }

    .item-category {
        font-size: 0.7rem;
        color: #95a5a6;
        margin-top: 2px;
        text-transform: uppercase;
    }

    .item-price {
        font-weight: 700;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        font-size: 1.2rem;
        margin-top: 15px;
    }

    .total-price {
        font-weight: 900;
        color: #27ae60;
    }

    .error-box {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        margin-top: 20px;
    }

    .btn-text {
        background: none;
        border: none;
        color: #c62828;
        text-decoration: underline;
        cursor: pointer;
        margin-top: 5px;
    }
</style>

@code {
    private IBrowserFile selectedFile;
    private bool isLoading = false;
    private string errorMessage;
    private ReceiptDto analysisResult;
    private int currentStep = 0;

    protected override async Task OnInitializedAsync()
    {
        var token = await LocalStorage.GetItemAsync<string>("authToken");
        if (string.IsNullOrEmpty(token))
        {
            NavManager.NavigateTo("/login");
        }
    }

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (errorMessage != null) errorMessage = null;
    }

    private void ResetState()
    {
        selectedFile = null;
        isLoading = false;
        errorMessage = null;
        analysisResult = null;
        currentStep = 0;
    }

    // İlerleme simülasyonu
    private async Task RunProgressSimulation()
    {
        currentStep = 1; StateHasChanged();
        await Task.Delay(800);
        if (!isLoading) return;

        currentStep = 2; StateHasChanged();
        // API'den cevap gelene kadar bekler
    }

    private async Task UploadReceipt()
    {
        if (selectedFile == null) return;

        try
        {
            // --- DOSYA OKUMA  ---
            long maxFileSize = 15 * 1024 * 1024;
            byte[] fileBytes;

            using (var stream = selectedFile.OpenReadStream(maxFileSize))
            using (var memoryStream = new MemoryStream())
            {
                await stream.CopyToAsync(memoryStream);
                fileBytes = memoryStream.ToArray();
            }

            // --- UI GÜNCELLEME ---
            isLoading = true;
            errorMessage = null;
            analysisResult = null;
            var progressTask = RunProgressSimulation();

            // ---  İSTEK HAZIRLIĞI ---
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (string.IsNullOrEmpty(token)) { NavManager.NavigateTo("/login"); return; }

            using var content = new MultipartFormDataContent();
            var fileContent = new ByteArrayContent(fileBytes);
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(selectedFile.ContentType);
            content.Add(fileContent, "file", selectedFile.Name);
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // --- GÖNDERİM ---
            var response = await Http.PostAsync("api/receipt/analyze", content);

            if (response.IsSuccessStatusCode)
            {
                currentStep = 3; StateHasChanged();
                await Task.Delay(600);
                currentStep = 4; StateHasChanged();
                await Task.Delay(400);

                var responseData = await response.Content.ReadFromJsonAsync<AnalyzeResponseDto>();
                analysisResult = responseData.Analysis;
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                errorMessage = $"Hata: {errorText}";
                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized) NavManager.NavigateTo("/login");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Hata: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}