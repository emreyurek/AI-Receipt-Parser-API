@page "/login"
@layout EmptyLayout
@using ReceiptParser.UI.Dto
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager

<div class="auth-container">
    <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
        <DataAnnotationsValidator />

        <div class="auth-card animate__animated animate__fadeInUp">

            <div class="text-center mb-4">
                <div class="logo-circle mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" /><polyline points="10 17 15 12 10 7" /><line x1="15" x2="3" y1="12" y2="12" /></svg>
                </div>
                <h2 class="fw-bold text-dark mb-1">Hesabına Giriş Yap</h2>
                <p class="text-muted small">Harcamalarını yönetmeye devam et.</p>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger rounded-3 small border-0 bg-danger bg-opacity-10 text-danger mb-4">
                    @errorMessage
                </div>
            }

            <div class="form-floating mb-3">
                <InputText @bind-Value="loginModel.Username" class="form-control rounded-3" id="floatingInput" placeholder="Kullanıcı Adı" />
                <label for="floatingInput" class="text-muted">Kullanıcı Adı</label>
            </div>

            <div class="form-floating mb-4">
                <InputText @bind-Value="loginModel.Password" type="password" class="form-control rounded-3" id="floatingPassword" placeholder="Şifre" />
                <label for="floatingPassword" class="text-muted">Şifre</label>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm btn-auth" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm"></span>
                }
                else
                {
                    <span>Giriş Yap</span>
                }
            </button>

            <div class="text-center mt-4">
                <span class="text-muted small">Henüz üye değil misin?</span>
                <a href="register" class="text-primary fw-bold text-decoration-none ms-1">Kayıt Ol</a>
            </div>
        </div>
    </EditForm>
</div>

<style>
    .auth-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
    }

    .auth-card {
        background: white;
        padding: 3rem 2.5rem;
        border-radius: 24px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.04);
        border: 1px solid #f0f0f0;
    }

    .logo-circle {
        width: 64px;
        height: 64px;
        background: #ebf5ff;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .form-control {
        border: 1px solid #e0e0e0;
        background-color: #fff;
    }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }

    .btn-auth {
        background-color: #2c3e50;
        border: none;
        transition: all 0.2s;
    }

        .btn-auth:hover {
            background-color: #34495e;
            transform: translateY(-1px);
        }

        .btn-auth:active {
            transform: scale(0.98);
        }
</style>

@code {

    public class UserLoginDto
    {
        [Required] public string Username { get; set; }
        [Required] public string Password { get; set; }
    }

    private UserLoginDto loginModel = new UserLoginDto();
    private string errorMessage;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            var response = await Http.PostAsJsonAsync("api/auth/login", loginModel);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResultDto>();
                await LocalStorage.SetItemAsync("authToken", result.Token);
                await LocalStorage.SetItemAsync("username", result.Username);
                NavManager.NavigateTo("/");
            }
            else { errorMessage = "Kullanıcı adı veya şifre hatalı."; }
        }
        catch (Exception ex) { errorMessage = "Bağlantı hatası."; }
        finally { isLoading = false; }
    }
}