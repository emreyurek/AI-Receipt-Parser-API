@page "/my-receipts"
@using ReceiptParser.UI.Dto
@using System.Net.Http.Headers
@using System.Text.Json
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavManager
@inject IJSRuntime JS

<PageTitle>Fişlerim</PageTitle>

<div class="container mt-4" style="max-width: 800px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0" style="color: #2c3e50;">📂 Fiş Geçmişi</h2>
        <button class="btn btn-sm btn-outline-primary rounded-pill px-3" @onclick="LoadReceipts">
            🔄 Yenile
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Fişleriniz yükleniyor...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger rounded-3 shadow-sm">
            @errorMessage
            <button class="btn btn-link btn-sm float-end text-danger text-decoration-none" @onclick="LoadReceipts">Tekrar Dene</button>
        </div>
    }
    else if (receipts == null || !receipts.Any())
    {
        <div class="text-center p-5 bg-white rounded-4 border border-dashed shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-journal-x text-muted mb-3" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M6.146 6.146a.5.5 0 0 1 .708 0L8 7.293l1.146-1.147a.5.5 0 1 1 .708.708L8.707 8l1.147 1.146a.5.5 0 0 1-.708.708L8 8.707 7.146 9.854a.5.5 0 0 1-.708-.708L7.293 8 6.146 6.854a.5.5 0 0 1 0-.708" />
                <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2" />
                <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z" />
            </svg>

            <h4 class="fw-bold text-secondary">Henüz hiç fiş yüklememişsiniz.</h4>
            <button class="btn btn-primary mt-3 rounded-pill px-4 py-2" @onclick='() => NavManager.NavigateTo("/")'>
                📸 İlk Fişini Yükle
            </button>
        </div>
    }
    else
    {
        <div class="row g-3">
            @foreach (var receipt in receipts)
            {
                <div class="col-12">
                    <div class="card shadow-sm border-0 rounded-3 overflow-hidden receipt-card">
                        <div class="card-body d-flex align-items-center justify-content-between p-3">

                            <div class="d-flex align-items-center gap-3">
                                <div class="icon-box bg-light text-primary rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                    🧾
                                </div>
                                <div>
                                    <h5 class="mb-0 fw-bold text-dark">@receipt.StoreName</h5>
                                    <small class="text-muted">
                                        📅 @receipt.ReceiptDate.ToString("d MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"))
                                        <span class="mx-2">•</span>
                                        <span class="badge bg-light text-secondary border">@receipt.LineItems?.Count ürün</span>
                                    </small>
                                </div>
                            </div>

                            <div class="text-end">
                                <h5 class="fw-bold text-success mb-0">@receipt.TotalAmount.ToString("N2") TL</h5>
                                <button class="btn btn-sm btn-link text-decoration-none p-0 mt-1 fw-bold" @onclick="() => ToggleDetails(receipt.Id)">
                                    @(expandedReceiptId == receipt.Id ? "Kapat ▲" : "Detaylar ▼")
                                </button>
                            </div>
                        </div>

                        @if (expandedReceiptId == receipt.Id)
                        {
                            <div class="card-footer bg-white border-top p-0 animate__animated animate__fadeIn">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0 table-hover align-middle">
                                        <thead class="text-muted small bg-light">
                                            <tr>
                                                <th class="ps-4 py-2">Ürün</th>
                                                <th class="py-2">Kategori</th>
                                                <th class="text-end pe-4 py-2">Tutar</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (receipt.LineItems != null)
                                            {
                                                @foreach (var item in receipt.LineItems)
                                                {
                                                    <tr>
                                                        <td class="ps-4">@item.ItemName</td>
                                                        <td><span class="badge bg-secondary bg-opacity-10 text-dark">@item.Category</span></td>
                                                        <td class="text-end pe-4 fw-bold text-secondary">@item.TotalLineAmount.ToString("N2")</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <div class="p-3 text-center bg-light">
                                    <button class="btn btn-sm btn-outline-danger px-4 rounded-pill" @onclick="() => DeleteReceipt(receipt.Id)">
                                        🗑️ Bu Fişi Sil
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .receipt-card {
        transition: all 0.2s ease;
        border: 1px solid #f0f0f0 !important;
    }

        .receipt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05) !important;
        }

    .border-dashed {
        border-style: dashed !important;
        border-width: 2px !important;
    }

    .icon-box {
        min-width: 50px;
    }
</style>

@code {
    private List<ReceiptListDto> receipts;
    private bool isLoading = true;
    private string errorMessage;
    private int? expandedReceiptId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadReceipts();
    }

    private async Task LoadReceipts()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (string.IsNullOrEmpty(token))
            {
                NavManager.NavigateTo("/login");
                return;
            }

            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetAsync("api/receipt/list");

            if (response.IsSuccessStatusCode)
            {
                receipts = await response.Content.ReadFromJsonAsync<List<ReceiptListDto>>();
                receipts = receipts.OrderByDescending(r => r.ReceiptDate).ToList();
            }
            else
            {
                if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                    NavManager.NavigateTo("/login");
                else
                    errorMessage = "Fişler yüklenirken bir sorun oluştu.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Bağlantı Hatası: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleDetails(int id)
    {
        if (expandedReceiptId == id) expandedReceiptId = null;
        else expandedReceiptId = id;
    }

    private async Task DeleteReceipt(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Bu fişi silmek istediğinize emin misiniz?");
        if (!confirmed) return;

        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            var response = await Http.DeleteAsync($"api/receipt/delete/{id}");

            if (response.IsSuccessStatusCode)
            {
                await LoadReceipts();
                expandedReceiptId = null;
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Fiş silinemedi.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Hata: {ex.Message}");
        }
    }
}